@page "/settings"

@using Microsoft.FluentUI.AspNetCore.Components.Extensions
@using Microsoft.JSInterop
@inject ILogger<Settings> Logger
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation


@rendermode InteractiveServer

<FluentDesignTheme @bind-Mode="@Mode"
				   @bind-OfficeColor="@OfficeColor"
				   @bind-CustomColor="@CustomColor"
				   StorageName="theme" />

<h3>Settings</h3>

<div style="padding: 20px;">
	<FluentStack Orientation="Orientation.Horizontal" VerticalGap="20" HorizontalGap="20"> 
		<FluentSelect   Label="Theme" Width="150px"
						Items="@(Enum.GetValues<DesignThemeModes>())"
						@bind-SelectedOption="@Mode" />
		<FluentSelect   Label="Color"
						Items="@(Enum.GetValues<OfficeColor>().Select(i => (OfficeColor?)i))"
			Height="200px" Width="250px" @bind-SelectedOption="@OfficeColor">
			<OptionTemplate>
				<FluentStack>
					<FluentIcon Value="@(new Icons.Filled.Size20.RectangleLandscape())" Color="Color.Custom"
						CustomColor="@(@context.ToAttributeValue() != "default" ? context.ToAttributeValue() : "#036ac4" )" />
					<FluentLabel>@context</FluentLabel>
				</FluentStack>
			</OptionTemplate>
		</FluentSelect>
		<FluentSelect   Label="Custom Theme"
						Items="@CustomThemes"
						@bind-SelectedOption="@SelectedCustomTheme"
						Width="250px"
						OptionText="@(i => i?.Name ?? string.Empty)">
			<OptionTemplate>
				<FluentStack>
					<FluentIcon Value="@(new Icons.Filled.Size20.RectangleLandscape())" Color="Color.Custom"
						CustomColor="@(context?.Color ?? string.Empty)" />
					<FluentLabel>@(context?.Name ?? string.Empty)</FluentLabel>
				</FluentStack>
			</OptionTemplate>
		</FluentSelect>
	</FluentStack>
</div>


@code {
    public DesignThemeModes Mode { get; set; }
    public OfficeColor? OfficeColor { get; set; }
    public string? CustomColor { get; set; }

    public record CustomThemeOption(string Name, string Color);

    public List<CustomThemeOption> CustomThemes { get; set; } = new()
    {
        new CustomThemeOption("None", ""),
        new CustomThemeOption("Dungeon", "#4A3728")
    };

    private CustomThemeOption? _selectedCustomTheme;
    public CustomThemeOption? SelectedCustomTheme
    {
        get => _selectedCustomTheme;
        set
        {
            _selectedCustomTheme = value;
            CustomColor = string.IsNullOrEmpty(value?.Color) ? null : value?.Color;
            // Clear OfficeColor when using custom theme
            if (!string.IsNullOrEmpty(CustomColor))
            {
                OfficeColor = null;
            }
            // Apply CSS class for Dungeon theme
            ApplyThemeClass();
        }
    }

    protected override void OnInitialized()
    {
        // Initialize to 'None' theme, but allow FluentDesignTheme to restore from storage
        _selectedCustomTheme = CustomThemes[0];
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (!string.IsNullOrEmpty(CustomColor))
            {
                // Sync the dropdown with the restored CustomColor from storage
                var matchingTheme = CustomThemes.FirstOrDefault(t => t.Color == CustomColor);
                if (matchingTheme != null)
                {
                    _selectedCustomTheme = matchingTheme;
                    StateHasChanged();
                }
            }
            // Apply theme class on first render
            await ApplyThemeClassAsync();
        }
    }

    private async void ApplyThemeClass()
    {
        await ApplyThemeClassAsync();
    }

    private async Task ApplyThemeClassAsync()
    {
        try
        {
            var isDungeon = _selectedCustomTheme?.Name == "Dungeon";
            await JSRuntime.InvokeVoidAsync("eval", 
                isDungeon 
                    ? "document.body.classList.add('dungeon-theme')" 
                    : "document.body.classList.remove('dungeon-theme')");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to apply theme class");
        }
    }

    void OnLoaded(LoadedEventArgs e)
    {
        Logger.LogInformation($"Loaded: {(e.Mode == DesignThemeModes.System ? "System" : "")} {(e.IsDark ? "Dark" : "Light")}");
    }

    void OnLuminanceChanged(LuminanceChangedEventArgs e)
    {
        Logger.LogInformation($"Changed: {(e.Mode == DesignThemeModes.System ? "System" : "")} {(e.IsDark ? "Dark" : "Light")}");
    }

}