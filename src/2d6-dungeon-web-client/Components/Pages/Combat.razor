@using System.Threading.Tasks
@using c5m._2d6Dungeon;

@rendermode InteractiveServer

@inject IDialogService DialogService

<h3>Combat Screen</h3>

@if(CombatState.Creature == null)
{
    <FluentLabel Typo="Typography.Body">Select the creature mentioned in the room description.</FluentLabel>
    <CreaturePicker ParentCreature="CombatState.Creature" ParentCreatureChanged="CreatureUpdated" ></CreaturePicker>
}
else{
    <FluentStack Orientation="Orientation.Vertical"  Width="100%" >

        <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween" Width="100%">
            <h3>Turn @CombatState.TurnCounter - @currentFighter.ToString()</h3> 
            <FluentButton   Appearance="Appearance.Accent" @onclick=StartNewFight IconStart="@(new Icons.Regular.Size16.ArrowCounterclockwise())" 
                            Title="Start a new fight - resets the combat screen">Start a new fight</FluentButton>
        </FluentStack>
        <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="2" >
            <ShiftButtons   rolledValue="@primaryDice"
                            shiftedValue="@primaryShiftedDice"  
                            ShiftLeft="@shiftLeft" 
                            DiceShifted="PrimaryDiceShifted"></ShiftButtons>
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="2" HorizontalGap="0" Width="145">
                <span>
                    <Dice color="Dice.DiceColor.red" size="Dice.DiceSize.regular" face="primaryShiftedDice" />
                    <Dice color="Dice.DiceColor.purple" size="Dice.DiceSize.regular" face="secondaryShiftedDice" />
                </span>
                @shiftLeft shift left
                <span>
                    <FluentButton   Appearance="Appearance.Accent" @onclick=Roll2Dice IconStart="@(new Icons.Regular.Size16.Cube())">Roll</FluentButton>
                    <FluentButton   Appearance="Appearance.Accent" @onclick=ResetDice IconStart="@(new Icons.Regular.Size16.ArrowCounterclockwise())" 
                                    Title="Resets the Dice before any shift adjustment" >Reset</FluentButton>
                </span>
            </FluentStack>
            <ShiftButtons   rolledValue="@secondaryDice" 
                            shiftedValue="@secondaryShiftedDice" 
                            ShiftLeft="@shiftLeft" 
                            DiceShifted="SecondaryDiceShifted"></ShiftButtons>
            <FluentSpacer Width="200"></FluentSpacer>
            <FluentButton Appearance="Appearance.Accent" @onclick=NextTurn IconStart="@(new Icons.Regular.Size16.ArrowNext())">End Turn</FluentButton>
        </FluentStack>


        <FluentStack Orientation="Orientation.Horizontal" Width="100%">
            <FluentCard Width="600px" id="adventurer-card-combat" Style="@GetCardStyle(FighterType.Adventurer)"> 
                @if (IsCurrentFighter(FighterType.Adventurer))
                {
                    <FluentBadge Appearance="Appearance.Accent" Icon="@(new Icons.Regular.Size16.Clock())" Style="margin-bottom:6px;">Current turn</FluentBadge>
                }
                <AdventurerCard Player="CombatState.Player" Extented=true Editable=true></AdventurerCard>
            </FluentCard>
            <FluentCard Width="400px">
                <QuickReferenceCombatCard   TurnCounter="@CombatState.TurnCounter" 
                                            ShiftAdjustment="@adjustmentShift" >
                </QuickReferenceCombatCard>
            </FluentCard>
            <FluentCard Width="400px" id="creature-card-combat" Style="@GetCardStyle(FighterType.Creature)">
                @if (IsCurrentFighter(FighterType.Creature))
                {
                    <FluentBadge Appearance="Appearance.Accent" Icon="@(new Icons.Regular.Size16.Clock())" Style="margin-bottom:6px;">Current turn</FluentBadge>
                }
                <CreatureCard creature="CombatState.Creature" Editable=true></CreatureCard> 
            </FluentCard>
        </FluentStack>
        <CombatJournal actions="CombatState.CombatActions" ></CombatJournal>
    </FluentStack>
}


@code {
    [Parameter]
    public required CombatState CombatState { get; set; }

    [Parameter] 
    public EventCallback<CombatState> CombatStateChanged { get; set; }

    private int adjustmentShift = 0;
    private int adjustedShift = 0;
    private DiceResult? originalDice;
    private int shiftLeft = 0;
    private int primaryDice = 0;
    private int primaryShiftedDice = 0;
    private int secondaryDice = 0;
    private int secondaryShiftedDice = 0;

    private FighterType? currentFighter;
    private FighterType? firstFighter;

    private bool IsCurrentFighter(FighterType fighter) => currentFighter == fighter;

    private string GetCardStyle(FighterType fighter)
    {
        return IsCurrentFighter(fighter)
            ? "border:2px solid var(--accent-fill-rest); box-shadow:0 0 8px var(--accent-fill-rest);"
            : "border:1px solid transparent;";
    }

    protected override async Task OnInitializedAsync()
    {
        adjustedShift = CombatState.Player.Shift;

        if (CombatState.TurnCounter == 0)
        {
            CombatTurnChanged(1);
            shiftLeft = adjustedShift;
        }
    }

    private async Task ShowSelectFirstFighterDialog()
    {
        var dialog = await DialogService.ShowDialogAsync<SelectFirstFighterDialog>(
            FighterType.Adventurer,
            new DialogParameters()
            {
                Title = "Combat Initiative",
                PrimaryAction = null,
                SecondaryAction = null,
                Width = "400px",
                Height = "200px",
                Modal = true,
                PreventDismissOnOverlayClick = true
            });

        var result = await dialog.Result;

        if (!result.Cancelled && result.Data is FighterType selectedFighter)
        {
            firstFighter = selectedFighter;
            SetCurrentFighterToFirstFighter();

            if (CombatState.TurnCounter == 0)
            {
                CombatTurnChanged(1);
                shiftLeft = adjustedShift;
            }

            var fighterName = firstFighter == FighterType.Adventurer ? "Adventurer" : "Creature";
            CombatState.CombatActions.Add($"{fighterName} attacks first");

            StateHasChanged();
        }
    }
    private void CombatTurnChanged(int turn){

        CombatState.TurnCounter = turn;

        if(turn < 7)
        {
            switch(turn)
            {
                case 4:
                    adjustmentShift = 1;
                    break;
                case 5:
                    adjustmentShift = 2;
                    break;
                case 6:
                    adjustmentShift = 3;
                    break;
            }

            if (adjustmentShift > 0)
                CombatState.CombatActions.Add($"Shift as been ajusted by {adjustmentShift} due to fatigue reaching {turn}");

            adjustedShift = CombatState.Player.Shift + adjustmentShift;
        }
        CombatStateChanged.InvokeAsync(CombatState);
    }

    private void Roll2Dice()
    {
        var dice = originalDice = DiceResult.Roll2Dice();
        primaryDice = primaryShiftedDice = dice.PrimaryDice;
        secondaryDice = secondaryShiftedDice = dice.SecondaryDice;

        CombatState.CombatActions.Add($"Rolled {primaryDice} and {secondaryDice}");

        shiftLeft = GetShiftLeftValue();

        StateHasChanged();
    }

    private void NextTurn()
    {
        ToggleCurrentFighter();

        if (currentFighter == firstFighter)
        {
            CombatState.TurnCounter++;
            CombatTurnChanged(CombatState.TurnCounter);
            shiftLeft = adjustedShift;
            CombatStateChanged.InvokeAsync(CombatState);
        }

        primaryDice = primaryShiftedDice = 0;
        secondaryDice = secondaryShiftedDice = 0;

        CombatState.CombatActions.Add($"Start Turn {CombatState.TurnCounter}");

        StateHasChanged();
    }

    private async Task CreatureUpdated(Creature selectedCreature)
    {
        CombatState.Creature = selectedCreature;
        await CombatStateChanged.InvokeAsync(CombatState);
        await ShowSelectFirstFighterDialog();
    }

    private async Task StartNewFight()
    {
        // Reset combat state
        CombatState.Creature = null;
        CombatState.TurnCounter = 0;
        CombatState.CombatActions.Clear();

        // Reset dice state
        primaryDice = primaryShiftedDice = 0;
        secondaryDice = secondaryShiftedDice = 0;
        originalDice = null;

        // Reset adjustments
        adjustmentShift = 0;
        adjustedShift = CombatState.Player.Shift;
        shiftLeft = 0;
        
        CombatState.CombatActions.Add("Combat reset - ready for a new fight");
        CombatStateChanged.InvokeAsync(CombatState);
        StateHasChanged();
    }

    private void SetCurrentFighterToFirstFighter()
    {
        currentFighter = firstFighter;
    }

    private void ToggleCurrentFighter()
    {
        currentFighter = currentFighter == FighterType.Adventurer
            ? FighterType.Creature
            : FighterType.Adventurer;
    }


    private void PrimaryDiceShifted(ShiftButtons.ShiftDirection shift)
    {
        int preValue = primaryShiftedDice;
        if (shift == ShiftButtons.ShiftDirection.Up)
        {
            primaryShiftedDice++;
        }
        else
        {
            primaryShiftedDice--;
        }
        CombatState.CombatActions.Add($"Primary dice Shifted from {preValue} to {primaryDice}");
        shiftLeft = GetShiftLeftValue();
        StateHasChanged();
    }

    private void SecondaryDiceShifted(ShiftButtons.ShiftDirection shift)
    {
        int preValue = secondaryShiftedDice;
        if (shift == ShiftButtons.ShiftDirection.Up)
        {
            secondaryShiftedDice++;
        }
        else
        {
            secondaryShiftedDice--;
        }
        CombatState.CombatActions.Add($"Secondary dice Shifted from {preValue} to {secondaryDice}");
        shiftLeft = GetShiftLeftValue();
        StateHasChanged();
    }

    private int GetShiftLeftValue(){
        var pDiceMovs = Math.Abs(primaryDice - primaryShiftedDice);
        var sDiceMovs = Math.Abs(secondaryDice - secondaryShiftedDice);
        var movLeft = adjustedShift - pDiceMovs - sDiceMovs;
        return movLeft;
        //return adjustedShift - Math.Abs(primaryDice - primaryShiftedDice) - Math.Abs(secondaryDice - secondaryShiftedDice);
    }

    private void ResetDice()
    {
        primaryDice = primaryShiftedDice = originalDice?.PrimaryDice ?? 0;
        secondaryDice = secondaryShiftedDice = originalDice?.SecondaryDice ?? 0;
        shiftLeft = adjustedShift;
        CombatState.CombatActions.Add($"Reset Dice");
        StateHasChanged();
    }

}
